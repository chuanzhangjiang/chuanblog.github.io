<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>scala编程之play框架使用</title><meta name="description" content="胸无大致，家里蹲！"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><link rel="icon" href="/chuanblog.github.io/images/favicon.ico"><link rel="stylesheet" href="/chuanblog.github.io/style/bulma.css"><link rel="stylesheet" href="/chuanblog.github.io/style/base.css"><link rel="stylesheet" href="/chuanblog.github.io/style/helper.css"><script src="/chuanblog.github.io/js/common.js"></script><link rel="stylesheet" href="/chuanblog.github.io/style/post.css"><link rel="stylesheet" href="/chuanblog.github.io/style/highlight-theme-light.css"><script src="/chuanblog.github.io/jslib/highlight.pack.js"></script><meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/chuanblog.github.io/atom.xml" title="Hexo" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-mobile"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/chuanblog.github.io/">chuan's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">scala编程之play框架使用</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/chuanblog.github.io/">Home</a></h3><h3 class="is-inline-block"><a href="/chuanblog.github.io/about">About</a></h3><h3 class="is-inline-block"><a href="/chuanblog.github.io/archives">Archives</a></h3></aside></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/chuanblog.github.io/">Home</a></h3><h3 class="is-inline-block"><a href="/chuanblog.github.io/about">About</a></h3><h3 class="is-inline-block"><a href="/chuanblog.github.io/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAplay%E9%A1%B9%E7%9B%AE"><span class="toc-text">新建play项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E9%A1%B9%E7%9B%AE"><span class="toc-text">运行项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BE%9D%E8%B5%96"><span class="toc-text">配置依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93-mysql"><span class="toc-text">配置数据库(mysql)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E8%87%AA%E5%8A%A8%E6%BC%94%E8%BF%9B%EF%BC%88evolutions%EF%BC%89"><span class="toc-text">使用数据库自动演进（evolutions）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8slick-codegen%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E4%BB%A3%E7%A0%81"><span class="toc-text">使用slick codegen自动生成数据库操作代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#slick%E4%BD%BF%E7%94%A8"><span class="toc-text">slick使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dao%E7%B1%BB%E6%A8%A1%E6%9D%BF"><span class="toc-text">dao类模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5"><span class="toc-text">查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E"><span class="toc-text">增</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSRF%E8%BF%87%E6%BB%A4%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">CSRF过滤器配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEapplication-conf%E6%96%87%E4%BB%B6"><span class="toc-text">配置application.conf文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E5%89%8D%E7%AB%AF%E8%AF%B7%E6%B1%82"><span class="toc-text">关于前端请求</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/chuanblog.github.io/tags/scala"><i class="tag post-item-tag">scala</i></a><a href="/chuanblog.github.io/tags/%E7%BC%96%E7%A8%8B"><i class="tag post-item-tag">编程</i></a><a href="/chuanblog.github.io/tags/play%20framework"><i class="tag post-item-tag">play framework</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">scala编程之play框架使用</h1><time class="has-text-grey" datetime="2021-01-14T13:06:54.000Z">2021-01-14</time><article class="mt-2 post-content"><ul>
<li><a href="#%E6%96%B0%E5%BB%BAplay%E9%A1%B9%E7%9B%AE">新建play项目</a></li>
<li><a href="#%E8%BF%90%E8%A1%8C%E9%A1%B9%E7%9B%AE">运行项目</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E4%BE%9D%E8%B5%96">配置依赖</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93mysql">配置数据库(mysql)</a><ul>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E8%87%AA%E5%8A%A8%E6%BC%94%E8%BF%9Bevolutions">使用数据库自动演进（evolutions）</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8slick-codegen%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E4%BB%A3%E7%A0%81">使用<code>slick codegen</code>自动生成数据库操作代码</a></li>
</ul>
</li>
<li><a href="#slick%E4%BD%BF%E7%94%A8">slick使用</a><ul>
<li><a href="#dao%E7%B1%BB%E6%A8%A1%E6%9D%BF">dao类模板</a></li>
<li><a href="#%E6%9F%A5">查</a></li>
<li><a href="#%E5%A2%9E">增</a></li>
</ul>
</li>
<li><a href="#csrf%E8%BF%87%E6%BB%A4%E5%99%A8%E9%85%8D%E7%BD%AE">CSRF过滤器配置</a><ul>
<li><a href="#%E9%85%8D%E7%BD%AEapplicationconf%E6%96%87%E4%BB%B6">配置<code>application.conf</code>文件</a></li>
<li><a href="#%E5%85%B3%E4%BA%8E%E5%89%8D%E7%AB%AF%E8%AF%B7%E6%B1%82">关于前端请求</a></li>
</ul>
</li>
</ul>
<h2 id="新建play项目"><a href="#新建play项目" class="headerlink" title="新建play项目"></a>新建play项目</h2><pre><code class="hljs plain">sbt new playframework/play-scala-seed.g8</code></pre>
<h2 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h2><p>terminal中运行</p>
<pre><code class="hljs plain">sbt run</code></pre>
<p>vscode中运行<br>launch.json文件</p>
<pre><code class="hljs plain">{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "type": "scala",
            "request": "launch",
            "name": "Play main",
            "mainClass": "play.core.server.ProdServerStart",
            "args": [],
            "jvmOptions": []
        }
    ]
}</code></pre>
<p>application.conf文件添加screatkey</p>
<pre><code class="hljs plain">play.http.secret.key=${?PLAY_SECREAT_KEY}</code></pre>
<p><code>~/.bashrc</code>中添加环境变量(如果使用zsh则添加在<code>~/.zshrc</code>中):</p>
<pre><code class="hljs plain">export PLAY_SECREAT_KEY='QCY?tAnfk?aZ?iwrNwnxIlR6CTf:G3gf:90Latabg@5241AB`R5W:1uDFN];Ik@n'</code></pre>
<p>刷新.bashrc文件.(关闭所有vscode界面和terminal界面)</p>
<pre><code class="hljs plain">source .bashrc</code></pre>
<h2 id="配置依赖"><a href="#配置依赖" class="headerlink" title="配置依赖"></a>配置依赖</h2><p>在build.sbt中添加如下依赖</p>
<pre><code class="hljs plain">libraryDependencies ++= Seq(
  "com.typesafe.play" %% "play-slick" % "5.0.0",
  "com.typesafe.play" %% "play-slick-evolutions" % "5.0.0",
  "com.typesafe.slick" %% "slick-codegen" % "3.3.3",
  "mysql" % "mysql-connector-java" % "5.1.41",
  "org.mindrot" % "jbcrypt" % "0.4"
)</code></pre>
<h2 id="配置数据库-mysql"><a href="#配置数据库-mysql" class="headerlink" title="配置数据库(mysql)"></a>配置数据库(mysql)</h2><p>在application.conf中添加配置(db.url自行替换):</p>
<pre><code class="hljs plain"># Default database configuration
slick.dbs.default.profile="slick.jdbc.MySQLProfile$"
slick.dbs.default.db.driver="com.mysql.jdbc.Driver"
slick.dbs.default.db.url="jdbc:mysql://192.168.1.249:3306/seed-store?useSSL=false&amp;characterEncoding=UTF-8"
slick.dbs.default.db.user=${?MYSQL_USER}
slick.dbs.default.db.password=${?MYSQL_PSD}</code></pre>
<p>~/.bashrc中添加环境变量:</p>
<pre><code class="hljs plain">export MYSQL_USER='{用户名}'
export MYSQL_PSD='{密码}'</code></pre>
<p>刷新.bashrc文件.(关闭所有vscode界面和terminal界面)</p>
<pre><code class="hljs plain">source ~/.bashrc</code></pre>
<p>配置项目中的logback.xml文件，在<code>&lt;root&gt;</code>节点之前添加以下语句使其能在控制台中显示SQL语句:</p>
<pre><code class="hljs plain">&lt;logger name="slick.jdbc.JdbcBackend.statement"  level="DEBUG" /&gt;</code></pre>
<h3 id="使用数据库自动演进（evolutions）"><a href="#使用数据库自动演进（evolutions）" class="headerlink" title="使用数据库自动演进（evolutions）"></a>使用数据库自动演进（evolutions）</h3><p>1.创建如下目录，其中default表示数据库名称（图中为默认数据库）,创建sql文件以1,2,3命名，表示时间先后顺序。</p>
<!-- ![evolutions](sql_evolutions.png) -->
<img src="/chuanblog.github.io/2021/01/14/scala%E7%BC%96%E7%A8%8B%E4%B9%8Bplay%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/sql_evolutions.png" class="">

<p>2.sql文件样例：</p>
<p>样例1：</p>
<pre><code class="hljs plain">-- !Ups

DROP TABLE IF EXISTS `user`;
CREATE TABLE `user` (
    `id` INT AUTO_INCREMENT,
    `username` VARCHAR(50) NOT NULL unique,
    `password` VARCHAR(50),
    `phone_number` VARCHAR(50),
    PRIMARY KEY (`id`)
)ENGINE InnoDB DEFAULT CHARSET=UTF8;

-- !Downs

DROP TABLE `user`;</code></pre>
<p>样例2：</p>
<pre><code class="hljs plain">-- !Ups

ALTER TABLE `product` ADD CONSTRAINT `prdct_foreign_key_prdct` FOREIGN KEY(`manufacturer_id`)
REFERENCES `manufacturer`(`id`);

-- !Downs

ALTER TABLE `product` DROP FOREIGN KEY `prdct_foreign_key_prdct`;</code></pre>
<p>样例3：</p>
<pre><code class="hljs plain">-- !Ups
CREATE TABLE operator (
	`id` INT AUTO_INCREMENT,
    `username` VARCHAR(50) NOT NULL unique,
    `password` VARCHAR(100) NOT NULL,
     PRIMARY KEY (`id`)
)ENGINE InnoDB DEFAULT CHARSET=UTF8;

INSERT INTO operator(username, password)
VALUES('admin', '$2a$10$D.DPASo7cAvdU9b0URPbY.www8lLK6PkJPQUT/TlWO.S84CYslzZO');

-- !Downs

DELETE FROM operator where username = 'admin';

DROP TABLE operator;</code></pre>
<p>写好sql之后运行一次项目，然后打开项目网页，会提示运行脚本，运行即可。</p>
<h3 id="使用slick-codegen自动生成数据库操作代码"><a href="#使用slick-codegen自动生成数据库操作代码" class="headerlink" title="使用slick codegen自动生成数据库操作代码"></a>使用<code>slick codegen</code>自动生成数据库操作代码</h3><p>方法一、在项目中创建一个main方法，每次数据库修改手动运行此main方法：</p>
<p>在项目源码目录新建scala文件,如下图:</p>
<!-- ![code_gen](slick_code_gen.png) -->

<img src="/chuanblog.github.io/2021/01/14/scala%E7%BC%96%E7%A8%8B%E4%B9%8Bplay%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/slick_code_gen.png" class="">

<p><code>Codegen.scala</code>文件内容样例如下:</p>
<pre><code class="hljs plain">import java.io.File
object CodeGen extends App {
  val dbHost = "localhost:3306"
  // val dbHost = "192.168.1.249:3306"
  val dbName = "manager-sys-demo"
  val dbUserName = System.getenv("MYSQL_USER")
  val dbPass = System.getenv("MYSQL_PSD")
  val sourceCodeDir = new File("").getAbsolutePath() + File.separator + "app"
  slick.codegen.SourceCodeGenerator.main(
    Array(
      "slick.jdbc.MySQLProfile",
      "com.mysql.jdbc.Driver",
      s"jdbc:mysql://${dbHost}/${dbName}?useSSL=false&amp;characterEncoding=UTF-8",
      sourceCodeDir,
      "models",
      dbUserName,
      dbPass
    )
  )
}</code></pre>
<p><code>/home/chuanzhangjiang/scala_project/seed-store/app/</code>源码目录,<code>models</code>为源码输出的包，使用里面的<code>Tables</code>对象即可。<br>每次数据库有修改，手动运行<code>Codegen.scala</code>即可。<br>方法二、配置sbt脚本，项目每次编译自动生成<code>Tables</code>对象:<br>修改<code>project</code>目录下的<code>plugins.sbt</code>文件,添加如下内容：</p>
<pre><code class="hljs plain">addSbtPlugin("com.github.tototoshi" % "sbt-slick-codegen" % "1.4.0")

//根据你所使用的数据库而定
libraryDependencies += "mysql" % "mysql-connector-java" % "5.1.41"</code></pre>
<p>修改<code>build.sbt</code>,添加如下内容:</p>
<pre><code class="hljs plain">import slick.codegen.SourceCodeGenerator
import slick.{model =&gt; m}

val hosetName = "//localhost:3306"
val dbName = "manager-sys-demo"

// required
slickCodegenSettings

// required
// Register codegen hook
sourceGenerators in Compile += slickCodegen.taskValue

// required 配置数据库url
slickCodegenDatabaseUrl := s"jdbc:mysql:${hosetName}/${dbName}?useSSL=false&amp;characterEncoding=UTF-8"

// required 从环境变量中获取登录数据库的用户名
slickCodegenDatabaseUser := System.getenv("MYSQL_USER")

// required 从环境变量中获取数据库密码
slickCodegenDatabasePassword := System.getenv("MYSQL_PSD")

// required slickCodegen数据库驱动,非字符串
slickCodegenDriver := slick.jdbc.MySQLProfile

// required jdbc驱动,字符串
slickCodegenJdbcDriver := "com.mysql.jdbc.Driver"

// optional but maybe you want `Tables`对象的包名
slickCodegenOutputPackage := "models"

//optional Tables.scala输出目录
// slickCodegenOutputDir := (sourceManaged in Compile).value

// optional 忽略指定表
// For example, to exclude play evolutions play_evolutions table from the target of codegen. This still applies after slickCodegenIncludedTables.
slickCodegenExcludedTables := Seq("play_evolutions")</code></pre>
<p>完成以上配置，sbt将在你每次编译项目的时候自动生产<code>Tables</code>对象。</p>
<p>附上<code>slick-codegen</code>sbt插件项目<a target="_blank" rel="noopener" href="https://github.com/tototoshi/sbt-slick-codegen">地址</a>。</p>
<h2 id="slick使用"><a href="#slick使用" class="headerlink" title="slick使用"></a>slick使用</h2><h3 id="dao类模板"><a href="#dao类模板" class="headerlink" title="dao类模板"></a>dao类模板</h3><pre><code class="hljs plain">import play.api.db.slick.DatabaseConfigProvider
import scala.concurrent.ExecutionContext
import com.google.inject.Inject
import play.api.db.slick.HasDatabaseConfigProvider
import slick.jdbc.JdbcProfile
import scala.concurrent.Future

class SampleDao @Inject() (
    protected val dbConfigProvider: DatabaseConfigProvider
)(implicit executionContext: ExecutionContext)
    extends HasDatabaseConfigProvider[JdbcProfile] {
  import profile.api._
  // TODO
}</code></pre>
<h3 id="查"><a href="#查" class="headerlink" title="查"></a>查</h3><pre><code class="hljs plain">val query = User.filter(_.email === mEmail).result
db.run(query)</code></pre>
<p><code>User</code>对象由<code>CodeGen.scala</code>自动生成，参考系列一。</p>
<h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><p>情况1:直接新增，返回被修改的行数。</p>
<pre><code class="hljs plain">def saveUser(newUser: UserRow): Future[Int] = {
  val action = User += newUser
  db.run(action)
}</code></pre>
<p>情况2:只提供部分列的数据,返回被修改的行数。</p>
<pre><code class="hljs plain">val action = User.map(user =&gt; (user.username, user.password, user.email)) += (
      username,
      password,
      email
    )
db.run(action)</code></pre>
<p>情况3:只提供部分列的数据，返回新增数据的自增id</p>
<pre><code class="hljs plain">val returnId = User
    .map(user =&gt; (user.username, user.password, user.email))
    .returning(User.map(_.id))

val action = returnId += (
    username,
    password,
    email
)</code></pre>
<p>持续更新中…</p>
<h2 id="CSRF过滤器配置"><a href="#CSRF过滤器配置" class="headerlink" title="CSRF过滤器配置"></a>CSRF过滤器配置</h2><h3 id="配置application-conf文件"><a href="#配置application-conf文件" class="headerlink" title="配置application.conf文件"></a>配置<code>application.conf</code>文件</h3><p>加入如下行</p>
<pre><code class="hljs plain">play.filters.csrf.header.bypassHeaders {
    X-Requested-With = "*"
}</code></pre>
<h3 id="关于前端请求"><a href="#关于前端请求" class="headerlink" title="关于前端请求"></a>关于前端请求</h3><p>此配置需要在前端请求头中加入<code>X-Requested-With</code>请求头，该请求头的值随意。(有的框架执行ajax请求会自动添加此header，如jquery)</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-small is-default py-4" href="/chuanblog.github.io/2021/01/14/vue%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/" title="vue项目配置文档"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: vue项目配置文档</span></a><a class="button is-small is-default py-4" href="/chuanblog.github.io/2021/01/14/openWRT/" title="openWRT"><span class="has-text-weight-semibold">Next: openWRT</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="chuanzhangjiang/chuanblog.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/chuanzhangjiang"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><a title="zhihu" target="_blank" rel="noopener nofollow" href="//zhihu.com/people/zhang-chuan-72-58"><i class="iconfont icon-zhihu"></i></a><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> chuan 2022</span></p><div class="is-flex"><p>Powered by Hexo｜</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by &nbspHaojen&nbsp</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/chuanblog.github.io/js/post.js"></script></body></html>